# Trip Card 實作說明

## 功能概述

已成功將 Dummy Card 替換為功能完整的 Trip Card，顯示兩個獨立的里程計（Trip 1 和 Trip 2）。

## 主要特點

### 1. 雙 Trip 計數器
- **Trip 1** 和 **Trip 2** 各自獨立計算里程
- 實時顯示累積公里數（保留一位小數）
- 使用梯形積分法計算距離，提高精確度

### 2. 獨立 Reset 功能
- 每個 Trip 都有專屬的 Reset 按鈕
- 點擊即可清零該 Trip 的里程數
- Reset 時會記錄重置時間

### 3. Reset 時間顯示
- 使用小字體顯示上次重置時間
- 格式：`Reset: YYYY-MM-DD HH:MM`
- 首次使用顯示 "Never reset"

## 計算原理

### 里程計算公式

使用**梯形積分法**計算距離：

```python
距離增量 = (前次速度 + 當前速度) / 2 × 時間間隔 / 3600
```

其中：
- 速度單位：km/h
- 時間間隔：秒 (s)
- 結果單位：公里 (km)

### 為什麼使用梯形積分？

相比簡單的矩形法（只用當前速度 × 時間），梯形積分能更準確地估算在速度變化過程中的實際行駛距離。

## UI 設計

### 佈局結構
```
┌─────────────────────────────────┐
│      Trip Computer (標題)       │
├─────────────────────────────────┤
│  Trip 1          [Reset按鈕]    │
│                                 │
│         123.4  km               │
│         (大字體顯示里程)         │
│                                 │
│     Reset: 2025-01-15 14:30     │
│     (小字體顯示重置時間)         │
├─────────────────────────────────┤
│  Trip 2          [Reset按鈕]    │
│                                 │
│          45.6  km               │
│                                 │
│     Reset: 2025-01-16 09:15     │
└─────────────────────────────────┘
```

### 樣式特點
- 深色漸層背景，與整體儀表板風格一致
- 半透明容器框，區分兩個 Trip
- 藍色主題色（#6af）用於標題和按鈕
- Reset 按鈕有 hover 和 pressed 效果
- 小字號灰色文字顯示重置時間

## 程式碼修改

### 新增檔案
- `TripCard` 類別（取代原 `DummyCard`）

### 修改位置
1. **main.py 頂部**：添加 `import time`
2. **Dashboard.init_ui()**：將 `self.dummy_card = DummyCard()` 改為 `self.trip_card = TripCard()`
3. **Dashboard._slot_set_speed()**：添加 `self.trip_card.update_speed(speed)` 以更新里程

### 關鍵方法
- `update_speed(speed_kmh)`: 接收速度並計算里程增量
- `reset_trip1()` / `reset_trip2()`: 重置對應的 Trip
- `update_reset_time_display()`: 更新重置時間顯示

## 測試方法

### 快速測試
```bash
python test_trip_card.py
```

這會啟動儀表板並模擬速度變化，觀察里程累積。

### 手動測試
1. 啟動主程式（`python main.py` 或 `python demo_mode.py`）
2. 滑動到第二列（Trip Card 所在位置）
3. 觀察隨著車速變化，里程數會實時更新
4. 點擊 Reset 按鈕測試重置功能
5. 檢查重置時間是否正確顯示

### CAN Bus 實車測試
```bash
python datagrab.py
```

在實車環境中，Trip Card 會根據實際速度訊號計算里程。

## 數據持久化（未來增強）

目前 Trip 數據僅在記憶體中，重啟程式會清零。未來可考慮：
1. 將 Trip 數據儲存到 JSON 檔案
2. 程式啟動時自動載入
3. 定期自動儲存（例如每分鐘）
4. 增加手動儲存/載入按鈕

## 技術細節

### 執行緒安全
- `update_speed()` 在主執行緒中被 `_slot_set_speed()` 呼叫
- 使用 PyQt6 的 Signal/Slot 機制確保執行緒安全
- 所有 UI 更新都在主執行緒執行

### 精度考量
- 使用浮點數儲存距離，避免累積誤差
- 時間間隔異常偵測（> 1秒視為異常，不計入）
- 顯示時四捨五入到小數點後一位

## 使用場景

1. **短程記錄（Trip 1）**：記錄單次出行距離
2. **累積記錄（Trip 2）**：記錄一段時間內的總里程
3. **油耗計算**：可配合油量數據計算平均油耗
4. **維護提醒**：達到一定里程時提醒保養

## 相關檔案

- `main.py`: TripCard 類別定義及整合
- `test_trip_card.py`: 測試腳本
- `datagrab.py`: CAN Bus 速度訊號來源
- `demo_mode.py`: 模擬模式測試

---

## ODO 卡片 (Odometer Card)

### 新增功能

在第二列新增了 **ODO（總里程表）卡片**，位於 Trip Card 旁邊。

### 主要特性

1. **總里程顯示**
   - 顯示車輛累積總里程
   - 整數顯示（不帶小數點），模擬真實里程表
   - 56px 大字體，清晰易讀

2. **虛擬數字鍵盤**
   - 點擊「同步里程」按鈕彈出
   - 0-9 數字按鈕
   - 退格鍵（⌫）刪除輸入
   - 確定/取消按鈕
   - 支援最多 7 位數（9,999,999 km）

3. **同步功能**
   - 手動輸入當前總里程
   - 記錄同步時間
   - 小字體顯示上次同步時間

4. **自動累積**
   - 與 Trip Card 同樣使用梯形積分法
   - 根據車速自動累積里程
   - 同步後繼續從設定值累積

### 使用場景

- **首次啟用**：透過虛擬鍵盤輸入儀表板當前里程
- **定期校準**：與實際里程表核對並同步
- **維護記錄**：追蹤車輛總行駛里程

### 測試方法

```bash
python test_odo_card.py
```

### 卡片佈局

第二列現有 2 張卡片：
1. Trip Card (Trip 1 & Trip 2)
2. ODO Card (總里程表)

使用左右滑動切換卡片。

---

**建立日期**: 2025-01-15  
**最後更新**: 2025-01-15  
**版本**: 1.1  
**狀態**: ✅ 已完成並測試
